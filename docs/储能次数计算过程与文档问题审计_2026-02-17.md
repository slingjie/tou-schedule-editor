# 储能次数计算过程与文档问题审计（2026-02-17）

## 1. 文档目的与范围

- 目的：固化当前程序中 `Storage Cycles` 页“充放次数”计算过程，避免口径混淆。
- 范围：当前仓库代码与以下 4 份文档的准确性审计。
- 审计对象：
  - `docs/储能次数计算待办.md`
  - `docs/储能次数计算对话关键内容记录.md`
  - `迁移任务方案/储能充放次数测算_迁移计划.md`
  - `docs/1.1新需求储能充放次数测算.md`

## 2. 当前程序中“次数计算”的权威流程（以代码为准）

### 2.1 页面到后端的调用链

1. 前端页面触发测算：
   - `components/StorageCyclesPage.tsx`
2. 前端调用后端接口：
   - `storageApi.ts:52` 使用 `POST /api/storage/cycles`
3. 后端入口：
   - `backend/app.py:457` `compute_storage_cycles`
4. 后端关键步骤：
   - 构造日运行逻辑：`build_daily_ops`（`backend/app.py:516`）
   - 构造 C1/C2 掩码：`build_daily_cycles_masks`（`backend/app.py:517`）
   - 跨午夜首尾拼接开启：`wrap_across_midnight=True`（`backend/app.py:520`）
   - 计算日度次数：`compute_window_avg_days_with_debug`（`backend/app.py:555`）
   - 汇总月/年次数：`backend/app.py:595-669`

### 2.2 日度次数主公式（当前主口径）

主口径来源函数：
- `backend/services/cycles.py:777` `compute_window_avg_days_with_debug`

核心计算过程：

1. 计算窗口许可功率与基础电量（窗口平均法）  
   对每个窗口（c1/c2 的 charge/discharge）：
   - 充电许可功率：`allow_ch = max(limit_kw - reserve_charge_kw - avg_load, 0)`
   - 放电许可功率：`allow_dis = max(avg_load - reserve_discharge_kw, 0)`
   - 基础电量：`base_kwh = allow_kw * hours`

2. 电网侧折算（受 `energy_formula` 影响）
   - `physics`：
     - `E_in_grid = base_ch * DOD / η`
     - `E_out_grid = base_dis * DOD * η`
   - `sample`：
     - `E_in_grid = base_ch / DOD * η`
     - `E_out_grid = base_dis / DOD / η`

3. 单窗口满充/满放等效比
   - `fc = min(E_in_grid / capacity_kwh, 1)`
   - `fd = min(E_out_grid / capacity_kwh, 1)`

4. 当日循环次数
   - `c1_cycles = min(fc1, fd1)`（`backend/services/cycles.py:913`）
   - `c2_cycles = min(fc2, fd2)`（`backend/services/cycles.py:938`）
   - `cycles_day = c1_cycles + c2_cycles`（`backend/services/cycles.py:959`）

### 2.3 月/年汇总与页面展示口径

1. 月度次数：后端将 `days[].cycles` 按 `YYYY-MM` 聚合  
   - `backend/app.py:597-609`, `backend/app.py:650-653`

2. 年累计循环次数：后端将 `months[].cycles` 求和  
   - `backend/app.py:658-669`

3. 前端“全年合计等效循环数”（展示指标）：
   - `yearEquivalentCycles = (yearTotalCycles / yearValidDays) * 365`（有效天数为 0 时取 0）
   - 代码位置：`components/StorageCyclesPage.tsx:2052-2056`

## 3. 易混淆项：页面里不止一种“次数”

### 3.1 主次数（循环次数）

- 来源字段：`days[].cycles` / `months[].cycles` / `year.cycles`
- 含义：C1/C2 充放窗口折算后的等效循环次数（主计算链路）

### 3.2 尖放电卡片中的“放电次数”

- 来源字段：`tip_discharge_summary.discharge_count`
- 后端函数：`backend/services/cycles.py:477` `compute_tip_discharge_summary`
- 其定义不是 `days[].cycles`：
  - 对每个“有尖且放电”的日期，统计 C1/C2 放电窗口是否与尖时段有交集，得到当日 `0~2` 次；
  - 再做逐日均值聚合（`backend/services/cycles.py:545-551`, `backend/services/cycles.py:577`）。
- 页面展示位置：`components/StorageCyclesPage.tsx:3893`

结论：`tip_discharge_summary.discharge_count` 与 `year/month/day cycles` 不是同一指标，不能混用。

## 4. 四份原文档审计结论

## 4.1 `docs/储能次数计算待办.md`

- 结论：有问题（轻度，主要为状态失真与口径混杂）。
- 发现问题：
  1. 待办与历史已完成事项混排，缺少“最后更新时间”和“当前是否仍适用”标识。
  2. 含收益初步公式讨论项（`docs/储能次数计算待办.md:17`），但未标注“讨论稿”，容易被误读为现网实现。
  3. `step_15min` 事项仍标待办（`docs/储能次数计算待办.md:2`），但现网已存在 `step15` 收益计算链路（`backend/app.py:571-583`），状态描述不完整。

## 4.2 `docs/储能次数计算对话关键内容记录.md`

- 结论：有问题（中低，主要为“对话记录”与“规范说明”边界不清）。
- 发现问题：
  1. 文档为沟通记录体例，未区分“已实现事实/讨论结论/未来计划”，后续维护者难直接作为规范引用。
  2. 对 `physics` 的“程序当前使用”表述较绝对，未强调 `energy_formula` 可切换（代码支持 physics/sample）。
  3. 文档内大量字段解释有效，但缺少对应代码锚点，不利于回归核查。

## 4.3 `迁移任务方案/储能充放次数测算_迁移计划.md`

- 结论：有问题（中高，存在接口契约过期）。
- 发现问题：
  1. 响应结构草案与现网不一致：文档写 `yearly_total_cycles/monthly_cycles/daily_cycles_head`（`迁移任务方案/储能充放次数测算_迁移计划.md:82-85`），现网为 `year/months/days`（`types.ts:228-233`）。
  2. 文档将 `step_15min` 定义为后续增强（`迁移任务方案/储能充放次数测算_迁移计划.md:69-70`），但现网已在收益链路引入 step15 计算（`backend/app.py:571-583`），存在“阶段状态”过期。
  3. 文档记录的参考程序目录在当前仓库内不可见，需标注为“外部依赖路径”并补充可访问性说明。

## 4.4 `docs/1.1新需求储能充放次数测算.md`

- 结论：有问题（中度，主要为需求讨论稿未转正）。
- 发现问题：
  1. 文档包含“先不要进行程序开发”（`docs/1.1新需求储能充放次数测算.md:35`）等阶段性沟通语句，不适合作为当前实现依据。
  2. 包含未闭环问题（如 `physics vs sample` 解释请求，`docs/1.1新需求储能充放次数测算.md:32-33`），未标注后续决议版本。
  3. 作为“需求讨论纪要”是有价值的，但不应替代“当前生效口径文档”。

## 5. 问题汇总（按优先级）

| 优先级 | 文档 | 问题摘要 | 影响 |
|---|---|---|---|
| 高 | `迁移任务方案/储能充放次数测算_迁移计划.md` | API 响应字段与现网类型不一致 | 联调与二次开发易按旧字段实现，直接出错 |
| 中 | `docs/1.1新需求储能充放次数测算.md` | 讨论稿内容未“状态化” | 新成员难判断哪些结论已生效 |
| 中 | `docs/储能次数计算对话关键内容记录.md` | 事实/讨论混用、缺代码锚点 | 口径理解偏差，审计成本高 |
| 低 | `docs/储能次数计算待办.md` | 历史待办未清理、状态不完整 | 误解优先级与实现状态 |

## 6. 建议修订动作

1. 将本文件作为“当前生效口径”入口文档，并在 4 份原文档头部加“状态标签”（讨论稿/历史记录/已过期/现行）。
2. 对 `迁移任务方案/储能充放次数测算_迁移计划.md` 增加“现网接口差异说明”章节，避免继续按草案字段开发。
3. 在 `docs/储能次数计算对话关键内容记录.md` 增加“实现状态”列（已实现/部分实现/未实现）并补代码定位。
4. 在 `docs/储能次数计算待办.md` 增加“最后更新日期 + 责任人 + 当前有效项”三列，沉淀为可执行待办。

## 7. 附录：关键代码定位清单

- 页面与 API：
  - `components/StorageCyclesPage.tsx`
  - `storageApi.ts:52`
  - `backend/app.py:457`

- 主次数计算：
  - `backend/services/cycles.py:913`
  - `backend/services/cycles.py:938`
  - `backend/services/cycles.py:959`

- 跨午夜拼接：
  - `backend/app.py:520`
  - `backend/services/cycles.py:304`

- 年等效展示：
  - `components/StorageCyclesPage.tsx:2052-2056`

- 尖放电次数：
  - `backend/services/cycles.py:477`
  - `backend/services/cycles.py:545-551`
  - `backend/services/cycles.py:577`
